"use strict";var T=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var B=(e,t)=>{for(var n in t)T(e,n,{get:t[n],enumerable:!0})},K=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of O(t))!L.call(e,o)&&o!==n&&T(e,o,{get:()=>t[o],enumerable:!(r=E(t,o))||r.enumerable});return e};var $=e=>K(T({},"__esModule",{value:!0}),e);var G={};B(G,{InvalidTokenError:()=>a,TokenError:()=>s,TokenExpiredError:()=>l,authenticate:()=>h,createAssertion:()=>A,getCoreApiBaseEndpoint:()=>j,getProvisioningApiBaseEndpoint:()=>R,jwtDecode:()=>i,jwtIsDashboard:()=>x,jwtIsIntegration:()=>C,jwtIsSalesChannel:()=>J,jwtIsUser:()=>k,jwtIsWebApp:()=>b,jwtVerify:()=>W,revoke:()=>S});module.exports=$(G);function y(e){return e.replace(/[A-Z]/g,t=>`_${t.toLowerCase()}`)}function u(e,t){return Object.keys(e).reduce((n,r)=>{let o=t(r);return n[o]=e[r],n},{})}function w(e){return e.replace(/([-_][a-z])/g,t=>t.toUpperCase().replace("-","").replace("_",""))}async function h(e,{domain:t="commercelayer.io",headers:n,...r}){let o=u({grant_type:e,...r},y),c=await(await fetch(`https://auth.${t}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...n},body:JSON.stringify(o)})).json();return c.errors==null&&(c.expires=new Date(Date.now()+c.expires_in*1e3)),u(c,w)}var s=class extends Error{constructor(t){super(t),this.name="TokenError"}};var a=class extends s{constructor(t){super(t),this.name="InvalidTokenError"}};function f(e,t){if(typeof btoa<"u"){let n=e;if(t==="utf-8"){let r=new TextEncoder().encode(e);n=String.fromCharCode(...r)}return btoa(n).replaceAll("=","").replaceAll("+","-").replaceAll("/","_")}return Buffer.from(e,t).toString("base64url")}function m(e,t){if(typeof atob<"u"){let n=atob(e.replaceAll("-","+").replaceAll("_","/").padEnd(e.length+(4-e.length%4)%4,"="));if(t==="utf-8"){let r=new Uint8Array([...n].map(o=>o.charCodeAt(0)));return new TextDecoder().decode(r)}return n}return Buffer.from(e,"base64url").toString(t)}function i(e){let[t,n,r]=`${e}`.split(".");if(t==null||n==null||r==null)throw new a("Invalid token format");return{header:JSON.parse(m(t,"binary")),payload:JSON.parse(m(n,"utf-8")),signature:r}}function k(e){return e.application.kind==="user"}function x(e){return e.application.kind==="dashboard"}function C(e){return e.application.kind==="integration"}function J(e){return e.application.kind==="sales_channel"}function b(e){return e.application.kind==="webapp"}function d(e){return e?.payload?.iss?.startsWith("https://auth.")?e.payload.iss:"https://auth.commercelayer.io"}async function S(e){let t=u(e,y),n=i(e.token),r=d(n);return await(await fetch(`${r}/oauth/revoke`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)})).json()}var l=class extends s{constructor(){super("Token expired"),this.name="TokenExpiredError"}};async function W(e,{ignoreExpiration:t=!1,jwk:n}={}){let r=i(e),o=n??await _(r);if(o==null||o.kid!==r.header.kid)throw new a('Invalid token "kid"');if(!t&&Date.now()>=r.payload.exp*1e3)throw new l;let p={name:"RSASSA-PKCS1-v1_5",hash:"SHA-512"},c=await crypto.subtle.importKey("jwk",o,p,!0,["verify"]),I=new Uint8Array(Array.from(m(r.signature,"binary"),v=>v.charCodeAt(0))),P=new TextEncoder().encode(e.split(".").slice(0,2).join("."));if(!await crypto.subtle.verify(p,c,I,P))throw new a("Invalid signature");return r}var g={};async function _(e){let{kid:t}=e.header;if(g[t]!=null)return g[t];let n=await U(e);return g[t]=n.find(r=>r.kid===t),g[t]}async function U(e){let t=`${d(e)}/.well-known/jwks.json`,n=await fetch(t).then(async r=>await r.json());if(n.keys==null)throw new s(`Invalid jwks response from "${t}": ${JSON.stringify(n)}`);return n.keys}async function A({payload:e}){return await D(e,"cl")}async function D(e,t){let r=f(JSON.stringify({alg:"HS512",typ:"JWT"}),"binary"),o=f(JSON.stringify({...e,iat:Math.floor(new Date().getTime()/1e3)}),"utf-8"),p=`${r}.${o}`,c=await z(p,t);return`${p}.${c}`}async function z(e,t){let n=new TextEncoder,r={name:"HMAC",hash:"SHA-512"},o=await crypto.subtle.importKey("raw",n.encode(t),r,!1,["sign","verify"]),p=await crypto.subtle.sign(r.name,o,n.encode(e));return f(String.fromCharCode(...new Uint8Array(p)),"binary")}function j(e,t={}){let{shouldThrow:n=!0}=t,r=i(e);if(!("organization"in r.payload)){if(n)throw new a("Invalid token format");return null}return d(r).replace("auth",r.payload.organization.slug)}function R(e,t={}){let{shouldThrow:n=!0}=t,r=i(e);if(!r?.payload?.scope?.includes("provisioning-api")){if(n)throw new a("Invalid token format");return null}return d(r).replace("auth","provisioning")}0&&(module.exports={InvalidTokenError,TokenError,TokenExpiredError,authenticate,createAssertion,getCoreApiBaseEndpoint,getProvisioningApiBaseEndpoint,jwtDecode,jwtIsDashboard,jwtIsIntegration,jwtIsSalesChannel,jwtIsUser,jwtIsWebApp,jwtVerify,revoke});
//# sourceMappingURL=index.cjs.mapf